!function(t,e){"function"==typeof define&&define.amd?define(e):"object"==typeof exports?module.exports=e(require,exports,module):t.StateFlow=e()}(this,function(){function t(t){this._locked=!1,this.name=t,this._discharge()}function e(e){if(!e)throw new Error(this.exception.NO_OPTIONS);this.checkType(e.type)&&(this.type=e.type),this.context=this.checkContext(e.context),this.fn=null,this.handler=new t(e.name),this.name=e.name,this.stateCallback=e.stateCallback,"function"==typeof e.fn&&(this.fn=e.fn),this.status=this.statuses.INITIAL,this.data=null,this.id=this.generateId(),this._runID=null,this._links={error:null,next:null,switchTo:null}}function s(t,e,s,i){if("string"!=typeof t)throw new Error("");"function"==typeof e&&(this._stateCallback=e),this.name=t,this.data=null,this.dataStates=[],this.steps=[],this.isReady=!1,this.isAfterCallbackApplied=!1,this.entryData=null,this.dataLog=[],this.stateLocator=s,this.pipeLocator=i}function i(t){this.pipes={},this.activePipe=null,this.stateLocator=t}function o(t){this.callbacks=[],this.data=null,this.name=t}t.prototype._callbackNames={next:"_nextCallback",error:"_errorCallback",switchTo:"_stateCallback"},t.prototype.getCurrentState=function(){return this.name},t.prototype.next=function(t){return this._locked?!1:(this.lock(),void this._nextCallback(t))},t.prototype.error=function(t){return this._locked?!1:(this.lock(),void this._errorCallback(t))},t.prototype.switchTo=function(t,e){return this._locked?!1:(this.lock(),void this._stateCallback(t,e))},t.prototype._nextCallbackStub=function(){},t.prototype._errorCallbackStub=function(){},t.prototype._stateCallbackStub=function(){},t.prototype.attachFunction=function(t,e){return this._locked?!1:void("string"==typeof t&&"function"==typeof e&&this._callbackNames[t]&&(this[this._callbackNames[t]]=e))},t.prototype.lock=function(){this._locked=!0},t.prototype.unlock=function(){this._locked=!1},t.prototype._discharge=function(){this.attachFunction("switchTo",this._stateCallbackStub),this.attachFunction("next",this._nextCallbackStub),this.attachFunction("error",this._errorCallbackStub)},e.prototype.exception={NO_OPTIONS:"options required for this action",WRONG_TYPE:"wrong PipeStep type was given"},e.prototype.statuses={INITIAL:1,IN_PROCESS:2,DONE:3,ERROR:4,STATE_CHANGED:5},e.prototype.pipeStepTypes={PROCESS:1,ERROR_HANDLER:2,BEFORE:3,AFTER:4,STATE:5},e.prototype.idBase=0,e.prototype.run=function(t){this.fn.apply(this.context,[t,this.handler])},e.prototype.generateId=function(){return"id"+this.constructor.prototype.idBase++},e.prototype.checkContext=function(t){var e;return e="object"!=typeof t?this:t},e.prototype.checkType=function(t){var e,s=null;for(var i in this.pipeStepTypes)this.pipeStepTypes.hasOwnProperty(i)&&(e=this.pipeStepTypes[i],e===t&&(s=!0));if(!s)throw new Error(this.exception.WRONG_TYPE);return s},e.prototype._linkTo=function(){},e.prototype._bindNextFunction=function(t){"function"==typeof t&&this.handler.attachFunction("next",t)},e.prototype.linkToProcess=function(t){var e,s;return t?(e=t.type===this.pipeStepTypes.PROCESS,s=t.type===this.pipeStepTypes.AFTER,e||s?void(this._links.next=t):!1):!1},e.prototype.linkToErrorHandler=function(t){var e;return t&&(e=t.type===this.pipeStepTypes.ERROR_HANDLER)?void(this._links.error=t):!1},e.prototype.attachStateSwitchCallback=function(t){this._links.switchTo=t},e.prototype._getActualRunID=function(){return this._runID},e.prototype.lock=function(){this.handler._discharge(),this.handler=this._createHandler(),this.handler.lock()},e.prototype.unlock=function(){this.handler.unlock()},e.prototype._createHandler=function(){var s=new t(this.name),i=this._links.next,o=this._links.error,n=this._links.switchTo,r=this;return s.attachFunction("next",function(t){r.status=r.statuses.DONE,r.data=t,i instanceof e&&i.run(t)}),s.attachFunction("error",function(t){r.status=r.statuses.ERROR,r.data=t,o instanceof e&&o.run(t)}),s.attachFunction("switchTo",function(t,s){r.status=r.statuses.STATE_CHANGED,r.data=s,n instanceof e?(n._bindNextFunction(function(e){r.stateCallback(t,e)}),n.run(s)):r.stateCallback(t,s)}),s},s.prototype.exception={WRONG_STEP:"given base step doesn't exist in pipe structure",NOT_READY:"the pipe isn't ready",EMPTY:"this pipe has no steps to run",AFTER_CALLBACK_EXISTS:"you can't register more than one AFTER callback",ALREADY_DESCRIBED:"you can't register any step after .described()"},s.prototype.use=function(t){var e=this.pipeLocator(t),s=e._cloneStepsArray();return this.steps.push.apply(this.steps,s),this},s.prototype.process=function(t,s){this._checkIfDescribed();var i={fn:t,context:s,stateCallback:this._stateCallback,type:e.prototype.pipeStepTypes.PROCESS};return this._createStep(i),this},s.prototype["do"]=s.prototype.process,s.prototype.after=function(t,s){if(this.isAfterCallbackApplied)throw new Error(this.exception.AFTER_CALLBACK_EXISTS);this._checkIfDescribed(),this.isAfterCallbackApplied=!0;var i={fn:t,context:s,stateCallback:this._stateCallback,type:e.prototype.pipeStepTypes.AFTER};return this._createStep(i),this},s.prototype.error=function(t,s){this._checkIfDescribed();var i={fn:t,context:s,stateCallback:this._stateCallback,type:e.prototype.pipeStepTypes.ERROR_HANDLER};return this._createStep(i),this},s.prototype.described=function(){this._checkIfDescribed();var t,e,s,i,o,n=this,r=function(t,e){var s=n.stateLocator(n.name);s&&"function"==typeof s.run?s.run(t):e.next(t)};for(this.isAfterCallbackApplied?this._getAfterStep()._bindNextFunction(r):this.after(r),this.isAfterCallbackApplied&&(i=this._getAfterStep()),o=0;o<this.steps.length;o++)t=this.steps[o],t!==i&&(s=this._closestProcess(t),e=this._closestErrorHandler(t),t.linkToProcess(s),t.linkToErrorHandler(e),this.isAfterCallbackApplied&&(s||t.linkToProcess(i)),t.attachStateSwitchCallback(i));return this._lockAllSteps(),this.isReady=!0,this},s.prototype.run=function(t){if(!this.isReady)throw new Error(this.exception.NOT_READY);this._unlockAllSteps(),this._findStepByType(e.prototype.pipeStepTypes.PROCESS).run(t)},s.prototype._closestStep=function(t,e){var s,i,o,n=this.steps.indexOf(t);if(0>n)throw new Error(this.exception.WRONG_STEP);for(o=n+1;!i&&o<this.steps.length;)s=this.steps[o],s.type===e&&(i=s),o++;return i},s.prototype._closestProcess=function(t){return this._closestStep(t,e.prototype.pipeStepTypes.PROCESS)},s.prototype._closestErrorHandler=function(t){return this._closestStep(t,e.prototype.pipeStepTypes.ERROR_HANDLER)},s.prototype._getAfterStep=function(){var t=null;return this.isAfterCallbackApplied&&(t=this._findStepByType(e.prototype.pipeStepTypes.AFTER)),t},s.prototype._log=function(){return this.steps.map(function(t){return{type:t.type,data:t.data,status:t.status}})},s.prototype._unlockAllSteps=function(){for(var t=0;t<this.steps.length;t++)this.steps[t].unlock()},s.prototype._lockAllSteps=function(){for(var t=0;t<this.steps.length;t++)this.steps[t].lock()},s.prototype._createStep=function(t){t.name=this.name;var s=new e(t);this.steps.push(s)},s.prototype._stateCallbackWrapper=function(){this.stateCallback()},s.prototype._stateCallback=function(){},s.prototype._checkIfDescribed=function(){if(this.isReady)throw new Error(this.exception.ALREADY_DESCRIBED)},s.prototype._findStepByType=function(t,e,s){if(!this.steps.length)throw new Error(this.exception.EMPTY);for(var i=null,o=s||0,n=e?-1:1,r=o;!i&&r>=0&&r<this.steps.length;)this.steps[r].type===t&&(i=this.steps[r]),r+=n;return i},s.prototype._cloneStepsArray=function(){for(var t=[],s=0;s<this.steps.length;s++){var i=new e(this.steps[s]);i.type!==e.prototype.pipeStepTypes.AFTER&&t.push(i)}return t},i.prototype.exception={WRONG_NAME:"wrong state's name given",NAME_EXISTS:"such state name already exists",NAME_DOES_NOT_EXIST:"such state name doesn't exist"},i.prototype.to=function(t){return this._checkNameAcceptable(t),this._checkNameExists(t),this.pipes[t]=new s(t,this.switchTo.bind(this),this.stateLocator,this._getPipeByName.bind(this)),this.pipes[t]},i.prototype.switchTo=function(t,e){if(!this.pipes.hasOwnProperty(t))throw new Error(this.exception.NAME_DOES_NOT_EXIST);this.activePipe=this.pipes[t],this._lockAll(),this.activePipe.run(e)},i.prototype.destroy=function(){this.stateLocator=null},i.prototype._checkNameExists=function(t){if(this.pipes.hasOwnProperty(t))throw new Error(this.exception.NAME_EXISTS)},i.prototype._checkNameAcceptable=function(t){if("string"!=typeof t||!t.length)throw new Error(this.exception.WRONG_NAME)},i.prototype._lockAll=function(){for(var t in this.pipes)this.pipes.hasOwnProperty(t)&&this.pipes[t]!==this.activePipe&&this.pipes[t]._lockAllSteps()},i.prototype._getPipeByName=function(t){if(!this.pipes.hasOwnProperty(t))throw new Error(this.exception.NAME_DOES_NOT_EXIST);return this.pipes[t]},o.prototype.exception={NOT_A_FUNCTION:"You need to pass an argument of type 'function'"},o.prototype.destroy=function(){this.callbacks=[]},o.prototype.attach=function(t,e){var s=e;if("function"!=typeof t)throw new Error(this.exception.NOT_A_FUNCTION);return"object"!=typeof e&&(s={}),this.callbacks.push({fn:t,context:s}),this},o.prototype.run=function(t){this.data=t;for(var e=0;e<this.callbacks.length;e++){var s=this.callbacks[e];s.fn.apply(s.context,[this.data,this.name])}};var n=function(){function t(t){var e;if("string"!=typeof t)throw new Error("");return e=n[t],e||(e=new o(t),n[t]=e),e}function e(){for(var t in n)n.hasOwnProperty(t)&&t.destroy();n={}}function s(t){return n[t]}var n={};return{create:function(){return this.flow||(this.flow=new i(s)),this.state||(this.state=t,this.state.destroy=e),this},destroy:function(){return this.flow&&(this.flow.destroy(),this.flow=null),this.state&&(this.state.destroy(),this.state=null),this}}}();return n});